<script>
  import { onMount } from 'svelte';
  import { collection, addDoc, Timestamp } from 'firebase/firestore'
  import { ref, update } from 'firebase/database';
  import {fstore, db, app} from '../../firebase';
  import Icon from '@iconify/svelte';
  
  let value = "";
  const getAction = (action) => {
    value = action;
  }  
  onMount(async()=>{
        let textarea = document.getElementById('textarea');
        let el = document.getElementsByClassName('optionClick');
        let takeAction = function (){
            let startPos = textarea.selectionStart;
            let endPos = textarea.selectionEnd;
            textarea.value = `${textarea.value.substring(0, startPos)}${value}${textarea.value.substring(endPos, textarea.value.length)}`
        }
        Array.from(el).forEach(function(el) {
          el.addEventListener('click', takeAction);
        })
    });


    let title, tags, qt, qta, content, mtags = false, express;
    let problems = [];
    let pname, plink, powner;

    const submitBlog = async () =>{
       let formData = {
          title: title,
          tags: tags,
          qt: qt,
          qta: qta,
          content: content,
          express: express
      }

        try {
          console.log({
                ...formData,
                createdAt: Timestamp.fromDate(new Date()),
                author: 'Faisal Shohag',
                like: 0,
                comments: 0,
                reports: [],
                read: 0,
                problems: [...problems]
          })
            const docRef = await addDoc(collection(fstore, "posts"), {
                ...formData,
                content: content,
                createdAt: Timestamp.fromDate(new Date()),
                author: 'Faisal Shohag',
                like: 0,
                comments: 0,
                reports: [],
                read: 0,
                problems: [...problems]
            });
            console.log('Document written with ID: ', docRef.id);
        } catch(err){
            console.log(err);
        }
    }

    const addProblem = ()=>{
      problems.push({
        name: pname,
        link: plink,
        owner: powner
      });
      console.log(problems);
      problems = problems
    }

    const processBlog = () => {
      setTimeout(()=>{
        document.querySelectorAll('pre code').forEach(el=>{
        hljs.highlightElement(el);
       });
       MathJax.typeset(); 
      }, 300);
    }

    

</script>


<div class="text-2xl font-hind font-bold">Add Info.</div>
<div class="variant-glass p-5 rounded-md flex flex-col gap-2">
<input class="input" type="text" placeholder="Title" bind:value={title} />
<input class="input" type="text" placeholder="Tags" bind:value={tags}/>
<input class="input" type="text" placeholder="Quote" bind:value={qt}/>
<input class="input" type="text" placeholder="QuoteAuthor" bind:value={qta} />
<input class="input" type="text" placeholder="Express few words..." bind:value={express} />
</div>		
<!-- problem show -->
<div class="text-2xl font-hind font-bold">Related Problems</div>
{#if problems.length>0}
{#each problems as problem}
  <div class="p-2 bg-green-500 text-white rounded-full mt-2">{problem.name}</div>
{/each}
{/if}
<!-- problem adding -->
<div>
  <input class="input" type="text" placeholder="Problem Name" bind:value={pname}/>
  <input class="input mt-1" type="text" placeholder="Problem Owner" bind:value={powner}/>
  <input class="input mt-1" type="text" placeholder="Problem link" bind:value={plink}/>
  <button on:click={addProblem} class="mt-5 bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded">Add</button>
</div>

<div class="text-2xl font-hind font-bold">Editor</div>
<div class="flex items-center gap-2 text-lg justify-center bg-gray-200 p-3 rounded-md">
  <!-- svelte-ignore a11y-click-events-have-key-events -->
  <div on:click={() => getAction(`<h1></h1>`)} class="optionClick p-2 variant-filled-secondary hover:variant-filled-primary rounded-lg cursor-pointer"><Icon icon="material-symbols:format-h1-rounded" /></div>
  <!-- svelte-ignore a11y-click-events-have-key-events -->
  <div on:click={() => getAction(`<h2></h2>`)} class="optionClick p-2 variant-filled-secondary hover:variant-filled-primary rounded-lg cursor-pointer"><Icon icon="material-symbols:format-h2-rounded" /></div>
  <!-- svelte-ignore a11y-click-events-have-key-events -->
  <div on:click={() => getAction(`<h5></h5>`)} class="optionClick p-2 variant-filled-secondary hover:variant-filled-primary rounded-lg cursor-pointer"><Icon icon="material-symbols:format-h5-rounded" /></div>
  <!-- svelte-ignore a11y-click-events-have-key-events -->
  <div on:click={() => getAction(`<b></b>`)} class="optionClick p-2 variant-filled-secondary hover:variant-filled-primary rounded-lg cursor-pointer"><Icon icon="ooui:bold-b" /></div>
  <!-- svelte-ignore a11y-click-events-have-key-events -->
  <div on:click={() => getAction(`<i></i>`)} class="optionClick p-2 variant-filled-secondary hover:variant-filled-primary rounded-lg cursor-pointer"><Icon icon="ooui:italic-i" /></div>
  <!-- svelte-ignore a11y-click-events-have-key-events -->
  <div on:click={() => getAction(`<u></u>`)} class="optionClick p-2 variant-filled-secondary hover:variant-filled-primary rounded-lg cursor-pointer"><Icon icon="ooui:underline-u" /></div>
  <!-- svelte-ignore a11y-click-events-have-key-events -->
  <div on:click={() => getAction(`<p></p>`)} class="optionClick p-2 variant-filled-secondary hover:variant-filled-primary rounded-lg cursor-pointer"><Icon icon="tabler:letter-p" /></div>
  <!-- svelte-ignore a11y-click-events-have-key-events -->
  <div on:click={() => getAction(`<pre><code class="language-"></code></pre>`)} class="optionClick p-2 variant-filled-secondary hover:variant-filled-primary rounded-lg cursor-pointer"><Icon icon="mingcute:code-fill" /></div>
  <!-- svelte-ignore a11y-click-events-have-key-events -->
  <div on:click={() => getAction(`$$`)} class="optionClick p-2 variant-filled-secondary hover:variant-filled-primary rounded-lg cursor-pointer"><Icon icon="fluent:math-formula-16-filled" /></div>
  <!-- svelte-ignore a11y-click-events-have-key-events -->
  <div on:click={() => getAction(`<code></code>`)} class="optionClick p-2 variant-filled-secondary hover:variant-filled-primary rounded-lg cursor-pointer"><Icon icon="fluent:highlight-16-filled" /></div>
</div>
<textarea id="textarea" class="w-full h-[300px] border-s-1 rounded-md border-gray-300" on:keydown={processBlog} bind:value={content}></textarea>

<div class="text-2xl font-hind font-bold">Preview</div>
<div class="flex gap-3 items-center md:float-right max-sm:hidden">
  <span class="badge variant-soft-primary cursor-pointer hover:variant-filled-primary">Stack</span>
  <span class="badge variant-soft-primary cursor-pointer hover:variant-filled-primary">Algo</span>
  <span class="badge variant-soft-primary cursor-pointer hover:variant-filled-primary">DSA</span>
  <span class="badge variant-soft-primary cursor-pointer hover:variant-filled-primary">Python</span>
</div>
<div class="text-2xl font-hind font-bold">{title ? title:'Title'}</div>
{#if mtags}
<div class="flex gap-3 items-center md:hidden">
  {#each tags as tag}
    <span class="badge variant-soft-primary cursor-pointer hover:variant-filled-primary">{tag}</span>
  {/each}
</div>
{/if}
<div class="m-0 p-0 flex items-center justify-between font-hind"> <div class="flex gap-1 items-center justify-between"><Icon icon="line-md:edit" /> <span class="strong">Faisal Shohag</span></div> <div class="flex gap-1 items-center justify-between"><Icon icon="line-md:calendar" /> <span class="text-orange">dd/mm/yy</span></div></div>
<hr />

<div class="blog">
  {@html content}
</div>

<button on:click={submitBlog} class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded">Submit</button>

